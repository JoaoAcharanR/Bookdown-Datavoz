[["construcción-de-ponderadores-por-raking.html", " 6 Construcción de ponderadores por Raking 6.1 Cargar bases de datos necesarias 6.2 Chequeo de variables 6.3 Recodificaciones 6.4 Construcción del ponderador", " 6 Construcción de ponderadores por Raking La siguiente sección pretende ejemplificar la manera de construir un ponderador utilizando la nueva metodología empleada por el Instituto Nacional de Estadísticas de Chile (INE). Para más información sobre la metodología visitar el siguiente link Para el ejemplo se pretende ponderar de acuerdo a las variables de: región, sexo, edad y educación. En este sentido, los valores que estimaremos como poblacionales de la región, el sexo y la edad los extraeremos de la BBDD de proyecciones del INE, mientras que los de educación los obtendremos desde la encuesta Casen 2020. Importante: para construir este tipo de ponderador es necesario utilizar la BBDD de estimaciones y proyecciones poblaciones del INE, la cual se puede descargar en el siguiente link 6.1 Cargar bases de datos necesarias Para llevar a cabo la construcción del ponderador necesitamos los siguientes elementos: BBDD de trabajo, a la cual queremos asignar ponderaciones. BBDD a seleccionadas por el analista. BBDD de proyecciones poblacionales a nivel país. Algo a tener en cuenta es que esta BBDD se actualiza año a año. # libreria library(haven) # BBDD de nuestro estudio (cambia segun caso) data1 &lt;- read_sav(&quot;BBDD/Base_final_DS2216_09_05_2022.sav&quot;, encoding = &quot;UTF-8&quot;) # BBDD para extraer ponderador de educacion (cambia segun caso) # Generalmente usamos CASEN 2017 O CASEN 2020 educ&lt;-read_sav(&quot;BBDD/Casen en Pandemia 2020_STATA PMulti.sav&quot;) # BBDD para construir las proyecciones (se actualiza año a año) proy &lt;- read_excel(&quot;BBDD/estimaciones-y-proyecciones-2002-2035-comunas.xlsx&quot;) 6.2 Chequeo de variables Como es costumbre, realizamos un primer análisis descriptivo de los datos para saber si debemos realizar recodificaciones o asignar valores perdidos. En este ejemplo emplearemos los siguientes códigos para realizar la labor, si embargo, la aplicación de determinadas librerías quedan a discreción del analista en cuestión. # Variables cualitativas # (sexo, nivel educacional y region) library(sjmisc) data1 %&gt;% frq(P1,P3,P4) # Variables cuantitativas # (edad) data1 %&gt;% sjmisc::descr(P2) 6.3 Recodificaciones Un requisito esencial para lograr construir el ponderador es que debemos homologar todas las variables que deseemos utilizar. Es decir, realizar todas las recodificaciones necesarias a las variables que extraeremos de las bases de datos externas, para que así presenten la misma composición y orden que las variables de nuestra base de datos de estudio. Estas recodificaciones son un elemento central en el cálculo de los ponderadores, pues con ellas lograremos asignar y reestructurar los pesos en caso de ser necesario. Importante: todas la recodificaciones que se presentan en el ejemplo responden a su contexto. Cualquier otra aplicación debe contener sus propias recodificaciones según el los objetivos del estudio. 6.3.1 Recodificación de variables en BBDD de estudio # sexo data1$P1&lt;-ifelse(data1$P1==1,&quot;Hombre&quot;,&quot;Mujer&quot;) # Recodificacion de edad en tramos (valida de emplear solo para variables numericas) data1&lt;-data1 %&gt;% mutate(edad_rec=case_when(between(P2,18,30)~ &quot;18 a 30 años&quot;, between(P2,31,40)~ &quot;31 a 40 años&quot;, between(P2,41,54)~ &quot;41 a 54 años&quot;, TRUE ~ &quot;55 años o más&quot;)) # region names(data1)[5]=&quot;region&quot; # educacion data1$P3&lt;-as.numeric(data1$P3) data1&lt;-data1 %&gt;% mutate(educ_rec=case_when(between(P3,1,5)~ &quot;humanidades completa o menos&quot;, between(P3,6,8)~ &quot;CFT inc-Universidad inc&quot;, TRUE ~ &quot;Universitaria completa o superior&quot;)) data1$educ_rec&lt;-factor(data1$educ_rec, levels = c(&quot;humanidades completa o menos&quot;, &quot;CFT inc-Universidad inc&quot;, &quot;Universitaria completa o superior&quot;)) # edad_Sexo data1$edad_sexo&lt;-paste0(data1$P1,&quot; &quot;,data1$edad_rec) data1$edad_sexo&lt;-as.character(data1$edad_sexo) data1$edad_sexo&lt;-factor(data1$edad_sexo, levels = c( &quot;Hombre 18 a 30 años&quot;, &quot;Hombre 31 a 40 años&quot;, &quot;Hombre 41 a 54 años&quot;, &quot;Hombre 55 años o más&quot;, &quot;Mujer 18 a 30 años&quot;, &quot;Mujer 31 a 40 años&quot;, &quot;Mujer 41 a 54 años&quot;, &quot;Mujer 55 años o más&quot;)) 6.3.2 Recodificaciones en BBDD de proyecciones pobalcionales # seleccionar variables de interes proy&lt;-proy[,c( &quot;Nombre Region&quot;, &quot;Sexo\\r\\n1=Hombre\\r\\n2=Mujer&quot;, &quot;Edad&quot;, &quot;Poblacion 2021&quot;)] # recodificar sexo names(proy)[2]=&quot;sexo&quot; # recodificar regiones proy$region &lt;- case_when(proy$`Nombre Region`==&quot;Tarapacá&quot; ~ 1, proy$`Nombre Region`==&quot;Antofagasta&quot; ~ 2, proy$`Nombre Region`==&quot;Atacama&quot; ~ 3, proy$`Nombre Region`==&quot;Coquimbo&quot; ~ 4, proy$`Nombre Region`==&quot;Valparaíso&quot; ~ 5, proy$`Nombre Region`==&quot;Libertador General Bernardo O&#39;Higgins&quot; ~ 6, proy$`Nombre Region`==&quot;Maule&quot; ~ 7, proy$`Nombre Region`==&quot;Biobío&quot; ~ 8, proy$`Nombre Region`==&quot;La Araucanía&quot; ~ 9, proy$`Nombre Region`==&quot;Los Lagos&quot; ~ 10, proy$`Nombre Region`==&quot;Aysén del General Carlos Ibáñez del Campo&quot; ~ 11, proy$`Nombre Region`==&quot;Magallanes y de la Antártica Chilena&quot; ~ 12, proy$`Nombre Region`==&quot;Metropolitana de Santiago&quot; ~ 13, proy$`Nombre Region`==&quot;Los Ríos&quot; ~ 14, proy$`Nombre Region`==&quot;Arica y Parinacota&quot; ~ 15, proy$`Nombre Region`==&quot;Ñuble&quot; ~ 16) 6.3.3 Proyecciones poblacionales mayores a 18 años # REGION proy.18&lt;-proy %&gt;% filter(Edad&gt;=18) %&gt;% select(&quot;Nombre Region&quot;,&quot;Poblacion 2021&quot;) # conteo de poblacion mayor de 18 años por region proy.18&lt;-proy.18 %&gt;% dplyr::group_by(`Nombre Region`) %&gt;% dplyr::summarise(n=sum(`Poblacion 2021`)) # proporcion de personas mayores de 18 años por region proy.18$porcentaje&lt;-proy.18$n/sum(proy.18$n) proy.18$orden &lt;- case_when(proy.18$`Nombre Region`==&quot;Tarapacá&quot; ~ 1, proy.18$`Nombre Region`==&quot;Antofagasta&quot; ~ 2, proy.18$`Nombre Region`==&quot;Atacama&quot; ~ 3, proy.18$`Nombre Region`==&quot;Coquimbo&quot; ~ 4, proy.18$`Nombre Region`==&quot;Valparaíso&quot; ~ 5, proy.18$`Nombre Region`==&quot;Libertador General Bernardo O&#39;Higgins&quot; ~ 6, proy.18$`Nombre Region`==&quot;Maule&quot; ~ 7, proy.18$`Nombre Region`==&quot;Biobío&quot; ~ 8, proy.18$`Nombre Region`==&quot;La Araucanía&quot; ~ 9, proy.18$`Nombre Region`==&quot;Los Lagos&quot; ~ 10, proy.18$`Nombre Region`==&quot;Aysén del General Carlos Ibáñez del Campo&quot; ~ 11, proy.18$`Nombre Region`==&quot;Magallanes y de la Antártica Chilena&quot; ~ 12, proy.18$`Nombre Region`==&quot;Metropolitana de Santiago&quot; ~ 13, proy.18$`Nombre Region`==&quot;Los Ríos&quot; ~ 14, proy.18$`Nombre Region`==&quot;Arica y Parinacota&quot; ~ 15, proy.18$`Nombre Region`==&quot;Ñuble&quot; ~ 16) # ordenar de forma ascendente proy.18&lt;-proy.18[order(proy.18$orden),] # ordenar de forma descendente #proy.18$orden &lt;- proy.18 %&gt;% dplyr::arrange(desc(orden)) # SEXO Y EDAD proy.18.se&lt;-proy %&gt;% filter(Edad&gt;=18) # homologamos la variable sexo con la distribucion de la bbdd de estudio proy.18.se$sexo&lt;-ifelse(proy.18.se$sexo==1,&quot;Hombre&quot;,&quot;Mujer&quot;) # homologamos la recodificacion de nuestra bbdd de estudio proy.18.se&lt;-proy.18.se %&gt;% mutate(edad_rec=case_when(between(Edad,18,30)~ &quot;18 a 30 años&quot;, between(Edad,31,40)~ &quot;31 a 40 años&quot;, between(Edad,41,54)~ &quot;41 a 54 años&quot;, TRUE ~ &quot;55 años o más&quot;)) # proy.18.se&lt;-proy.18.se %&gt;% dplyr::group_by(edad_rec,sexo) %&gt;% dplyr::summarise(n=sum(`Poblacion 2021`)) # proy.18.se&lt;-proy.18.se %&gt;% ungroup() # remueve agrupacion proy.18.se$porcentaje&lt;-proy.18.se$n/sum(proy.18.se$n) proy.18.se$edad_sexo&lt;-paste0(proy.18.se$sexo,&quot; &quot;,proy.18.se$edad_rec) 6.3.4 Recodificación BBDD Casen 2020 # NIVEL EDCUCACIONAL # seleccionamos los casos mayores a 18 años educ&lt;-educ %&gt;% filter(edad&gt;=18) # nuevo dataframe con educacion y personas mayores a 18 años educ1&lt;-educ %&gt;% select(educ) # transformacion de la variable a numérica educ1$educ&lt;-as.numeric(educ1$educ) # eliminamos los valores perdidos codificados como 99 educ1&lt;-educ1 %&gt;% filter(educ&lt;99) # recodificacion homologa de la variable educ1&lt;-educ1 %&gt;% mutate(educ_rec=case_when(between(educ,0,6)~ &quot;humanidades completa o menos&quot;, between(educ,7,9)~ &quot;CFT inc-Universidad inc&quot;, TRUE ~ &quot;Universitaria completa o superior&quot;)) # asigancion del orden de las categorias educ1$educ_rec&lt;-factor(educ1$educ_rec, levels = c(&quot;humanidades completa o menos&quot;, &quot;CFT inc-Universidad inc&quot;, &quot;Universitaria completa o superior&quot;)) ## creacion tabla de proporciones ## # a. nombres educacion.n&lt;-data.frame(names(table(educ1$educ_rec))) # b. proporciones educacion.n$prop&lt;-as.vector(prop.table(table(educ1$educ_rec))) # c. nombre de primera variable names(educacion.n)[1]=&quot;educ&quot; # d. asignacion de categorias educacion.n$educ &lt;-factor(educacion.n$educ, levels = c(&quot;humanidades completa o menos&quot;, &quot;CFT inc-Universidad inc&quot;, &quot;Universitaria completa o superior&quot;)) 6.4 Construcción del ponderador 6.4.1 Creación de un objeto sin pesos El argumento ids se utiliza para decirle a la encuesta que todos los datos provienen de una sola unidad primaria de muestreo. En data debemos agregar nuestra BBDD original. library(survey) dummy_survey_unweighted &lt;- svydesign(ids = ~1, data = data1, weights = NULL) 6.4.2 Crear las distribuciones marginales poblacionales de cada variable a utilizar para ponderar Aquí agregar todas las distribuciones marginales de todas las variables que se desean ponderar. Cada marco de datos consta de dos vectores: uno que describe los niveles del factor asociado y el otro las frecuencias correspondientes. Tenga en cuenta que multiplicamos las frecuencias relativas teóricamente conocidas como las hemos obtenido de nuestra población de referencia con el número de filas en el conjunto de datos para el que calculamos los pesos, para obtener frecuencias absolutas. El nombre del vector que describe los niveles del factor, tiene que ser el mismo nombre que tiene la variable en la bbdd y la misma codificación del factor en la base de datos original. Verificar que los nombres de la base en comuna, estén en el mismo orden que en la base proy.18. Para el ejemplo: como no tienen el mismo orden de levels ordenaré BBDD$REGION EN BASE A LO QUE APARECE EN LAS PROYECCIONES # REGION # dist. marginal reg_dist &lt;- tibble(region = c(names(table(data1$region))), Freq = nrow(data1)*c(proy.18$porcentaje)) # SEXO_EDAD # ordenar variables proy.18.se&lt;-proy.18.se[order(proy.18.se$edad_sexo),] # dist. marginal gender_edad_dist &lt;- tibble(edad_sexo = c(names(table(proy.18.se$edad_sexo))), Freq = nrow(data1)*c(proy.18.se$porcentaje)) # EDUCACION # ordenar variables data1&lt;-data1[order(data1$educ_rec),] # dist. marginal nivel_educ_dist&lt;-tibble(educ_rec = c(names(table(educacion.n$educ))), Freq = nrow(data1)*c(educacion.n$prop)) 6.4.3 Cáluclo del ponderador # CALCULO DE PONDERACIONES dummy_gender_rake &lt;- survey::rake(design = dummy_survey_unweighted, # objeto sin pesos sample.margins = list(~edad_sexo, # variables a extraer ~region, ~educ_rec), population.margins = list(gender_edad_dist, # objetos de donde reg_dist, # se extraen las nivel_educ_dist)) # variables ### ¡OJO, deben tener le mismo orden! # si quiero las variables edad_sexo, region y educ_rec, debo asegurarme que # el orden de los objetos debe seguir la misma logica, de esta manera R # &quot;sabra donde buscar&quot; para encontrar tales variables ## Comprobamos que los ponderadores esten bien construidos # como convención, los valores deben ser mayores a 0.3 y menores a 3 summary(weights(dummy_gender_rake)) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.2457 0.5346 0.8631 1.0000 1.4661 2.2611 ## En caso que no oscilen entre estos valores tenemos dos opciones: # 1) volver a los pasos anteriores y recodificar de tal manera que los pesos # tomen el rango deseado (recomendado). # 2) utilizar el siguiente codigo, el cual fuerza un recorte de los ponderadores # de acuerdo al rango que le asignemos. # dummy_gender_rake.rake.trim &lt;- # nuevo objeto con ponderadores forzados # trimWeights(dummy_gender_rake, # objeto con ponderadores # lower=0.3, # rango: minimo # upper=3, # rango: maximo # strict=TRUE) # forzar la funcion # Pasar los pesos a la bbdd original data1$Pond&lt;-weights(dummy_gender_rake) # asegurarse que la suma de los puntajes de los ponderadores sean igual al # n muestral data1$Pond %&gt;% sum() ## [1] 1000 "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
